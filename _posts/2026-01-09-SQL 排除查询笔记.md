# SQL 排除查询笔记

## 一、精准排除（精确匹配）

### 1. 单个值排除
```sql
-- 使用 != 或 <>
WHERE p.plan_type != '盆底评估方案'
WHERE p.plan_type <> '盆底评估方案'
```

### 2. 多个值排除
```sql
-- 使用 NOT IN（推荐）
WHERE p.plan_type NOT IN ('盆底评估方案', '', '测试方案')

-- 使用多个 AND
WHERE p.plan_type != '盆底评估方案'
  AND p.plan_type != ''
  AND p.plan_type != '测试方案'
```

### 3. 同时处理 NULL 值的优雅写法
```sql
-- 使用 COALESCE 处理 NULL，再用 NOT IN 排除
WHERE COALESCE(p.plan_type, '') NOT IN ('盆底评估方案', '')

-- 等价于：
WHERE p.plan_type IS NOT NULL
  AND p.plan_type != ''
  AND p.plan_type != '盆底评估方案'
```

## 二、模糊排除（模式匹配）

### 1. 基本 LIKE 排除
```sql
-- 排除以"盆底"开头的
WHERE p.plan_type NOT LIKE '盆底%'

-- 排除以"方案"结尾的
WHERE p.plan_type NOT LIKE '%方案'

-- 排除包含"评估"的
WHERE p.plan_type NOT LIKE '%评估%'
```

### 2. 排除多个模式
```sql
WHERE p.plan_type NOT LIKE '%盆底%'
  AND p.plan_type NOT LIKE '%评估%'
  AND p.plan_type NOT LIKE '%康复%'
```

## 三、组合排除场景

### 场景1：精确排除 + 处理 NULL
```sql
-- 排除特定值和NULL
WHERE COALESCE(p.plan_type, '') NOT IN ('盆底评估方案', '', '其他方案')
```

### 场景2：精确排除 + 模糊排除
```sql
-- 排除精确值，同时排除包含关键词的
WHERE p.plan_type != '盆底评估方案'
  AND p.plan_type NOT LIKE '%盆底%'
  AND p.plan_type NOT LIKE '%测试%'
```

### 场景3：复杂条件排除（CASE WHEN）
```sql
WHERE CASE 
  WHEN p.plan_type LIKE '%盆底%' THEN 0
  WHEN p.plan_type LIKE '%评估%' THEN 0
  WHEN p.plan_type = '' THEN 0
  WHEN p.plan_type IS NULL THEN 0
  ELSE 1
END = 1
```

## 四、不同数据库的扩展功能

### MySQL
```sql
-- 正则表达式排除
WHERE p.plan_type NOT REGEXP '盆底|评估|康复'

-- 排除空字符串和NULL
WHERE NULLIF(TRIM(p.plan_type), '') IS NOT NULL
```

### PostgreSQL
```sql
-- 正则表达式排除
WHERE p.plan_type !~ '盆底|评估|康复'

-- SIMILAR TO 排除
WHERE p.plan_type NOT SIMILAR TO '%(盆底|评估)%'
```

### SQL Server
```sql
-- PATINDEX 排除
WHERE PATINDEX('%盆底%', p.plan_type) = 0
  AND p.plan_type IS NOT NULL
```

## 五、性能考虑与最佳实践

### 1. 性能注意事项
```sql
-- ❌ 可能无法使用索引（通配符开头）
WHERE p.plan_type NOT LIKE '%盆底%'

-- ✅ 如果可能，使用正向条件
WHERE p.plan_type LIKE '正常%'  -- 优于 NOT LIKE

-- ✅ 使用 EXISTS 替代 NOT IN（处理大量数据时）
WHERE EXISTS (
  SELECT 1 FROM allowed_plans ap
  WHERE ap.plan_type = p.plan_type
)
```

### 2. 索引友好写法
```sql
-- 对索引更友好：先精确匹配，再模糊匹配
WHERE p.plan_type != '盆底评估方案'
  AND (p.plan_type NOT LIKE '%评估%' OR p.plan_type IS NULL)
```

### 3. 推荐写法模板

#### 模板1：通用精确排除
```sql
WHERE COALESCE(字段名, '默认值') NOT IN ('值1', '值2', '值3')
```

#### 模板2：精确+模糊组合排除
```sql
WHERE 字段名 IS NOT NULL
  AND 字段名 != ''
  AND 字段名 NOT LIKE '%关键词1%'
  AND 字段名 NOT LIKE '%关键词2%'
```

#### 模板3：灵活的条件排除
```sql
WHERE CASE 
  WHEN 条件1 THEN 0
  WHEN 条件2 THEN 0
  WHEN 条件3 THEN 0
  ELSE 1
END = 1
```

## 六、实用示例集合

### 示例1：用户数据清洗
```sql
-- 清理无效用户名
WHERE COALESCE(username, '') NOT IN ('', 'admin', 'test', 'guest')
  AND username NOT LIKE '%delete%'
  AND username NOT LIKE '%temp%'
```

### 示例2：产品目录过滤
```sql
-- 过滤产品类型
WHERE product_type IS NOT NULL
  AND product_type != '样品'
  AND product_type NOT LIKE '%测试%'
  AND product_type NOT LIKE '%废弃%'
```

### 示例3：日志数据筛选
```sql
-- 排除调试日志和空操作
WHERE COALESCE(log_type, '') NOT IN ('DEBUG', '', 'TEST')
  AND action NOT LIKE '%skip%'
  AND action NOT LIKE '%ignore%'
```

---

## 快速选择指南

| 需求场景 | 推荐写法 | 示例 |
|---------|---------|------|
| 排除固定几个值 | `NOT IN` | `NOT IN ('A', 'B', 'C')` |
| 排除NULL和空值 | `COALESCE + NOT IN` | `COALESCE(col, '') NOT IN ('')` |
| 排除包含关键词 | `NOT LIKE '%关键词%'` | `NOT LIKE '%测试%'` |
| 排除多种模式 | 多个 `NOT LIKE` | `NOT LIKE '%A%' AND NOT LIKE '%B%'` |
| 复杂条件排除 | `CASE WHEN` | `CASE WHEN...END = 1` |
| 需要高性能 | 避免 `NOT LIKE '%...%'` | 使用正向条件或预计算字段 |

记住关键点：**`COALESCE` 处理 NULL，`NOT IN` 排除精确值，`NOT LIKE` 排除模式**。
